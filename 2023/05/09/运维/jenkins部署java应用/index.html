<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>è¿ç»´/jenkinséƒ¨ç½²javaåº”ç”¨ | å°é»‘çš„å°ç«™</title><meta name="description" content="jenkinséƒ¨ç½²javaåº”ç”¨å¤§è‡´æµç¨‹ præ¨é€ è§¦å‘jenkinsæ„å»ºä»»åŠ¡ æ¸…ç©ºjenkinså·¥ä½œç›®å½• æ‹‰å–gitä»£ç  åœ¨å·¥ä½œåŒºåˆ›å»º&#x2F;Publicç›®å½• æ–°å»ºå¹¶å†™å…¥git log åˆ°result.html ä½¿ç”¨Mavenè¿›è¡Œæ„å»ºæ‰“åŒ… äº§ç‰©åœ¨å·¥ä½œåŒºçš„&#x2F;ruoyi-admin&#x2F;target&#x2F;ruoyi-admin.jar å°†äº§ç‰©å’ŒDockerfile ä¼ åˆ°è¿œç¨‹æœåŠ¡å™¨çš„&#x2F;home&#x2F;xxx&#x2F;xxx-ser"><meta name="author" content="å°é»‘"><meta name="copyright" content="å°é»‘"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="dns-prefetch" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="dns-prefetch" href="https://fonts.googleapis.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="dns-prefetch" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="è¿ç»´/jenkinséƒ¨ç½²javaåº”ç”¨"><meta name="twitter:description" content="jenkinséƒ¨ç½²javaåº”ç”¨å¤§è‡´æµç¨‹ præ¨é€ è§¦å‘jenkinsæ„å»ºä»»åŠ¡ æ¸…ç©ºjenkinså·¥ä½œç›®å½• æ‹‰å–gitä»£ç  åœ¨å·¥ä½œåŒºåˆ›å»º&#x2F;Publicç›®å½• æ–°å»ºå¹¶å†™å…¥git log åˆ°result.html ä½¿ç”¨Mavenè¿›è¡Œæ„å»ºæ‰“åŒ… äº§ç‰©åœ¨å·¥ä½œåŒºçš„&#x2F;ruoyi-admin&#x2F;target&#x2F;ruoyi-admin.jar å°†äº§ç‰©å’ŒDockerfile ä¼ åˆ°è¿œç¨‹æœåŠ¡å™¨çš„&#x2F;home&#x2F;xxx&#x2F;xxx-ser"><meta name="twitter:image" content="http://ynxh.xyz/img/linux.jpeg"><meta property="og:type" content="article"><meta property="og:title" content="è¿ç»´/jenkinséƒ¨ç½²javaåº”ç”¨"><meta property="og:url" content="http://ynxh.xyz/2023/05/09/%E8%BF%90%E7%BB%B4/jenkins%E9%83%A8%E7%BD%B2java%E5%BA%94%E7%94%A8/"><meta property="og:site_name" content="å°é»‘çš„å°ç«™"><meta property="og:description" content="jenkinséƒ¨ç½²javaåº”ç”¨å¤§è‡´æµç¨‹ præ¨é€ è§¦å‘jenkinsæ„å»ºä»»åŠ¡ æ¸…ç©ºjenkinså·¥ä½œç›®å½• æ‹‰å–gitä»£ç  åœ¨å·¥ä½œåŒºåˆ›å»º&#x2F;Publicç›®å½• æ–°å»ºå¹¶å†™å…¥git log åˆ°result.html ä½¿ç”¨Mavenè¿›è¡Œæ„å»ºæ‰“åŒ… äº§ç‰©åœ¨å·¥ä½œåŒºçš„&#x2F;ruoyi-admin&#x2F;target&#x2F;ruoyi-admin.jar å°†äº§ç‰©å’ŒDockerfile ä¼ åˆ°è¿œç¨‹æœåŠ¡å™¨çš„&#x2F;home&#x2F;xxx&#x2F;xxx-ser"><meta property="og:image" content="http://ynxh.xyz/img/linux.jpeg"><meta property="article:published_time" content="2023-05-09T06:27:04.701Z"><meta property="article:modified_time" content="2023-05-09T06:33:46.896Z"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><link rel="canonical" href="http://ynxh.xyz/2023/05/09/%E8%BF%90%E7%BB%B4/jenkins%E9%83%A8%E7%BD%B2java%E5%BA%94%E7%94%A8/"><link rel="prev" title="è¿ç»´/ç½‘ç»œç›¸å…³" href="http://ynxh.xyz/2023/05/09/%E8%BF%90%E7%BB%B4/%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3/"><link rel="next" title="è¿ç»´/jenkinsä½¿ç”¨" href="http://ynxh.xyz/2023/04/25/%E8%BF%90%E7%BB%B4/jenkins%E4%BD%BF%E7%94%A8/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"http://ynxh.xyz","msgToTraditionalChinese":"ç¹","msgToSimplifiedChinese":"ç°¡"},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  bookmark: {
    message_prev: 'æŒ‰',
    message_next: 'é”®å°†æœ¬é¡µåŠ å…¥ä¹¦ç­¾'
  },
  runtime_unit: 'å¤©',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: {"bookmark":{"message_prev":"æŒ‰","message_next":"é”®å°†æœ¬é¡µåŠ å…¥ä¹¦ç­¾"},"chs_to_cht":"ä½ å·²åˆ‡æ¢ä¸ºç¹ä½“","cht_to_chs":"ä½ å·²åˆ‡æ¢ä¸ºç®€ä½“","day_to_night":"ä½ å·²åˆ‡æ¢ä¸ºæ·±è‰²æ¨¡å¼","night_to_day":"ä½ å·²åˆ‡æ¢ä¸ºæµ…è‰²æ¨¡å¼","bgLight":"#49b1f5","bgDark":"#2d3035","position":"bottom-left"},
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.1"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length_num">125</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> æ—¶é—´è½´</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-heartbeat" aria-hidden="true"></i><span> æ¸…å•</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> éŸ³ä¹</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw fa fa-picture-o"></i><span> ç…§ç‰‡</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> ç”µå½±</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> å‹é“¾</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> å…³äº</span></a></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">ç›®å½•</div><div class="sidebar-toc__progress"><span class="progress-notice">ä½ å·²ç»è¯»äº†</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#jenkinséƒ¨ç½²javaåº”ç”¨"><span class="toc-number">1.</span> <span class="toc-text">jenkinséƒ¨ç½²javaåº”ç”¨</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#å¤§è‡´æµç¨‹"><span class="toc-number">1.0.1.</span> <span class="toc-text">å¤§è‡´æµç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#å°è¯•æ–¹å¼ä¸€"><span class="toc-number">1.0.2.</span> <span class="toc-text">å°è¯•æ–¹å¼ä¸€</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#å°è¯•æ–¹å¼äºŒ"><span class="toc-number">1.0.3.</span> <span class="toc-text">å°è¯•æ–¹å¼äºŒ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#è¿™é‡Œæœ‰å‡ ä¸ªå‘è®°å½•ä¸‹"><span class="toc-number">1.0.4.</span> <span class="toc-text">è¿™é‡Œæœ‰å‡ ä¸ªå‘è®°å½•ä¸‹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ä»¥ä¸‹å›ç­”æ¥è‡ªgptï¼Œäº²æµ‹å¯ç”¨"><span class="toc-number">1.0.4.1.</span> <span class="toc-text">ä»¥ä¸‹å›ç­”æ¥è‡ªgptï¼Œäº²æµ‹å¯ç”¨</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(/img/linux.jpeg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">å°é»‘çš„å°ç«™</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> æ—¶é—´è½´</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-heartbeat" aria-hidden="true"></i><span> æ¸…å•</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> éŸ³ä¹</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw fa fa-picture-o"></i><span> ç…§ç‰‡</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> ç”µå½±</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> å‹é“¾</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> å…³äº</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">è¿ç»´/jenkinséƒ¨ç½²javaåº”ç”¨</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="å‘è¡¨äº 2023-05-09 14:27:04"><i class="fa fa-calendar" aria-hidden="true"></i> å‘è¡¨äº 2023-05-09</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="æ›´æ–°äº 2023-05-09 14:33:46"><i class="fa fa-history" aria-hidden="true"></i> æ›´æ–°äº 2023-05-09</span></time></div><div class="meta-secondline"> <span class="post-meta-wordcount"><i class="post-meta__icon fa fa-file-word-o" aria-hidden="true"></i><span>å­—æ•°æ€»è®¡:</span><span class="word-count">2.5k</span><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-clock-o" aria-hidden="true"></i><span>é˜…è¯»æ—¶é•¿: 12 åˆ†é’Ÿ</span></span></div><div class="meta-thirdline"><span class="post-meta-pv-cv"><span class="post-meta__separator">|</span><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div id="article-container"><h1 id="jenkinséƒ¨ç½²javaåº”ç”¨"><a href="#jenkinséƒ¨ç½²javaåº”ç”¨" class="headerlink" title="jenkinséƒ¨ç½²javaåº”ç”¨"></a>jenkinséƒ¨ç½²javaåº”ç”¨</h1><h3 id="å¤§è‡´æµç¨‹"><a href="#å¤§è‡´æµç¨‹" class="headerlink" title="å¤§è‡´æµç¨‹"></a>å¤§è‡´æµç¨‹</h3><ol>
<li>præ¨é€</li>
<li>è§¦å‘jenkinsæ„å»ºä»»åŠ¡</li>
<li>æ¸…ç©ºjenkinså·¥ä½œç›®å½•</li>
<li>æ‹‰å–gitä»£ç </li>
<li>åœ¨å·¥ä½œåŒºåˆ›å»º/Publicç›®å½•</li>
<li>æ–°å»ºå¹¶å†™å…¥git log åˆ°result.html</li>
<li>ä½¿ç”¨Mavenè¿›è¡Œæ„å»ºæ‰“åŒ…</li>
<li>äº§ç‰©åœ¨å·¥ä½œåŒºçš„/ruoyi-admin/target/ruoyi-admin.jar</li>
<li>å°†äº§ç‰©å’ŒDockerfile ä¼ åˆ°è¿œç¨‹æœåŠ¡å™¨çš„/home/xxx/xxx-server ç›®å½•</li>
<li>åœ¨è¿œç¨‹æœåŠ¡å™¨ç«¯ æ‰§è¡Œdocker build æ‰“åŒ…æˆxxx-serveré•œåƒ</li>
<li>åœ¨è¿œç¨‹æœåŠ¡ç«¯ æ‰§è¡Œ docker run è¿è¡Œåœ¨20111ç«¯å£ï¼Œå¹¶æŠŠæ—¥å¿—æŒ‚è½½åˆ° /home/xxx/xxx-server/logs</li>
<li>å‘slackæ¨é€</li>
</ol>
<p>å®ç°æ–¹å¼ï¼š</p>
<ol>
<li>å®‰è£…maven ï¼ŒPublish Over SSH , docker æ’ä»¶ ï¼Œä½¿ç”¨maven project æµç¨‹æ¥æ„å»º</li>
<li>ä½¿ç”¨pipeline å’Œ jenkinsfile è‡ªå®šä¹‰æµç¨‹ çš„æ–¹å¼å®ç°ã€‚</li>
</ol>
<h3 id="å°è¯•æ–¹å¼ä¸€"><a href="#å°è¯•æ–¹å¼ä¸€" class="headerlink" title="å°è¯•æ–¹å¼ä¸€"></a>å°è¯•æ–¹å¼ä¸€</h3><ul>
<li>å®‰è£…maven æ’ä»¶ï¼Œé…ç½®è‡ªåŠ¨å®‰è£…</li>
<li>å®‰è£…docker æ’ä»¶ï¼Œé…ç½®è‡ªåŠ¨å®‰è£…</li>
<li>å®‰è£… Publish Over SSH æ’ä»¶ï¼Œé…ç½®æ—¶å‘ç°ï¼Œsshæµ‹è¯•ä¸€ç›´ä¸èƒ½æˆåŠŸã€‚<br> æ­¥éª¤å¦‚ä¸‹ï¼š  <ol>
<li>å°†jenkins å®¹å™¨ä¸­çš„.ssh ä¸‹çš„id_rsa.pub å…¬é’¥æ‹·è´åˆ° è¿œç¨‹æœåŠ¡å™¨çš„authorized_keys æ–‡ä»¶</li>
<li>å°†jenkins å®¹å™¨ä¸­çš„.ssh ä¸‹çš„id_rsa ç§é’¥æ‹·è´åˆ°jenkins çš„SSH æ’ä»¶å…¨å±€é…ç½®</li>
<li>test æŠ¥é”™ class="lazyload" data-src="https://user-images.githubusercontent.com/40491203/236610686-32ffdb4b-b6e0-42f8-8d04-8e215aea6d19.png" <img width="1243" alt="image" src="/">

</li>
</ol>
</li>
</ul>
<blockquote>
<p>ç„¶è€Œï¼Œç›´æ¥åœ¨å®¹å™¨å†…ï¼Œssh æ˜¯å¯ä»¥å…å¯†ç›´æ¥è¿æ¥åˆ°è¿œç¨‹çš„ï¼Œå°±æ˜¯è¿™ä¸ªæ’ä»¶çš„testè¿‡ä¸å»ã€‚</p>
</blockquote>
<ul>
<li><p>æ–°å»ºmaven é¡¹ç›®æ„å»ºæµç¨‹</p>
</li>
<li><p>åœ¨jenkinså®¹å™¨ä¸­ .sshç›®å½• ç”Ÿæˆå¯†é’¥å¯¹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -b 4096 -C &quot;xxx-server@troy.com&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>é…ç½®git åœ°å€ä¸deploy key</p>
</li>
<li><p>é…ç½®webhook</p>
</li>
<li><p>é…ç½®build å‘½ä»¤</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clean package -Dmaven.test.skip&#x3D;true</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ„å»ºæˆåŠŸå æ‰§è¡Œ Send build artifacts over SSH æŠŠjaråŒ…å’Œdockerfile ä¸¢è¿‡å»</p>
</li>
<li><p>æ„å»ºæˆåŠŸå å†æ‰§è¡Œ  shell è„šæœ¬ è¿›è¡Œdocker build å’Œ run</p>
</li>
</ul>
<blockquote>
<p>ç”±äºå¡åœ¨äº†  Publish Over SSH æ’ä»¶ é…ç½®ï¼Œè€Œä¸”è¿™ä¸ªæ–¹å¼ä¼¼ä¹ä¸å¤Ÿçµæ´»ï¼Œè¿˜éœ€è¦æ·»åŠ ä¸€äº›shellè„šæœ¬æ¥å®ç°git log å†™å…¥å’Œslackæ¨é€ç­‰ï¼Œè€Œä¸”è¿˜å¾—å»å­¦ä¹ å„ç§æ’ä»¶é…ç½®ï¼Œæ— æ³•æŠŠå·²æœ‰çš„jenkinsfile ä¸­çš„æµç¨‹ä¸€é”®è¿ç§»ï¼ˆä¹Ÿå¾—ä¸€ä¸ªä¸€ä¸ªåŠ shellè„šæœ¬æï¼‰ï¼Œé‚æš‚æ—¶æ”¾å¼ƒã€‚å»ææ–¹å¼äºŒ</p>
</blockquote>
<h3 id="å°è¯•æ–¹å¼äºŒ"><a href="#å°è¯•æ–¹å¼äºŒ" class="headerlink" title="å°è¯•æ–¹å¼äºŒ"></a>å°è¯•æ–¹å¼äºŒ</h3><ol>
<li>é¡¹ç›®æ ¹ç›®å½•åˆ›å»º jenkinsfile æ¨åˆ°ä»“åº“</li>
<li>åœ¨jenkinsfile è¯­æ³•ä¸­å®Œæˆä¸‹é¢æ­¥éª¤ğŸ‘‡ğŸ»</li>
<li>è°ƒç”¨sh å‘½ä»¤å®Œæˆæ‰“åŒ…æ­¥éª¤</li>
<li>æŠŠäº§ç‰©å’Œdockerfileä¸¢åˆ°è¿œç¨‹æœåŠ¡å™¨</li>
<li>ssh åˆ°è¿œç¨‹æœåŠ¡å™¨æ‰“åŒ…é•œåƒå’Œè¿è¡Œé•œåƒ</li>
<li>è¿è¡ŒæˆåŠŸåï¼Œslackæ¨é€æ¶ˆæ¯</li>
</ol>
<h3 id="è¿™é‡Œæœ‰å‡ ä¸ªå‘è®°å½•ä¸‹"><a href="#è¿™é‡Œæœ‰å‡ ä¸ªå‘è®°å½•ä¸‹" class="headerlink" title="è¿™é‡Œæœ‰å‡ ä¸ªå‘è®°å½•ä¸‹"></a>è¿™é‡Œæœ‰å‡ ä¸ªå‘è®°å½•ä¸‹</h3><ol>
<li><p>ç”±äºjenkinså®¹å™¨ä¸­æ˜¯æ²¡æœ‰å®‰è£…è¿‡dockerå’Œmavençš„ï¼Œå¿…é¡»æ‰‹åŠ¨å»å®‰è£…ä¸€ä¸‹ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt update</span><br><span class="line">apt install maven</span><br></pre></td></tr></table></figure>
</li>
<li><p>å®‰è£…dockeræ˜¯ä¸ªå‘ï¼Œaptæºæ²¡æœ‰docker</p>
</li>
</ol>
<h4 id="ä»¥ä¸‹å›ç­”æ¥è‡ªgptï¼Œäº²æµ‹å¯ç”¨"><a href="#ä»¥ä¸‹å›ç­”æ¥è‡ªgptï¼Œäº²æµ‹å¯ç”¨" class="headerlink" title="ä»¥ä¸‹å›ç­”æ¥è‡ªgptï¼Œäº²æµ‹å¯ç”¨"></a>ä»¥ä¸‹å›ç­”æ¥è‡ªgptï¼Œäº²æµ‹å¯ç”¨</h4><p>   è¦åœ¨Debian GNU/Linux 11ä¸Šå®‰è£…Dockerï¼Œæ‚¨å¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š</p>
<ol>
<li><p>æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br></pre></td></tr></table></figure>
</li>
<li><p>å®‰è£…ä¾èµ–åŒ…ï¼Œä»¥ä¾¿æ‚¨å¯ä»¥é€šè¿‡HTTPSä½¿ç”¨Dockerå­˜å‚¨åº“ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install apt-transport-https ca-certificates curl gnupg2 software-properties-common</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ·»åŠ Dockerå®˜æ–¹GPGå¯†é’¥ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL https:&#x2F;&#x2F;download.docker.com&#x2F;linux&#x2F;debian&#x2F;gpg | sudo gpg --dearmor -o &#x2F;usr&#x2F;share&#x2F;keyrings&#x2F;docker-archive-keyring.gpg</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ·»åŠ Dockerå­˜å‚¨åº“åˆ°æ‚¨çš„APTæºåˆ—è¡¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo \</span><br><span class="line">  &quot;deb [arch&#x3D;amd64 signed-by&#x3D;&#x2F;usr&#x2F;share&#x2F;keyrings&#x2F;docker-archive-keyring.gpg] https:&#x2F;&#x2F;download.docker.com&#x2F;linux&#x2F;debian \</span><br><span class="line">  $(lsb_release -cs) stable&quot; | sudo tee &#x2F;etc&#x2F;apt&#x2F;sources.list.d&#x2F;docker.list &gt; &#x2F;dev&#x2F;null</span><br><span class="line">&#96;&#96;&#96;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ›´æ–°APTè½¯ä»¶åŒ…åˆ—è¡¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br></pre></td></tr></table></figure>
</li>
<li><p>å®‰è£…Docker Engineå’Œdocker-composeï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install docker-ce docker-ce-cli containerd.io docker-compose</span><br></pre></td></tr></table></figure>
</li>
<li><p>å¯åŠ¨DockeræœåŠ¡ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start docker</span><br></pre></td></tr></table></figure>
</li>
<li><p>éªŒè¯Dockeræ˜¯å¦å·²æˆåŠŸå®‰è£…ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run hello-world</span><br><span class="line"></span><br><span class="line">å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œæ‚¨åº”è¯¥ä¼šçœ‹åˆ°ä¸€ä¸ªæ¬¢è¿æ¶ˆæ¯ï¼Œè¡¨ç¤ºDockerå·²ç»æˆåŠŸå®‰è£…ã€‚</span><br></pre></td></tr></table></figure>
</li>
<li><p>docker build å¿…é¡»è¦è¿›å…¥åˆ°è¿œç¨‹éƒ¨ç½²ç›®å½•å»æ‰§è¡Œï¼Œè¿™ä¸ªç‚¹æ²¡æ³¨æ„å°±ä¼šåœ¨å½“å‰å·¥ä½œç›®å½•æ‰§è¡Œäº†ã€‚</p>
</li>
<li><p>è¯­æ³•å‘ï¼Œæ³¨æ„è½¬ä¹‰ç¬¦å·ï¼ŒåŒå¼•å·å†…çš„åŒå¼•å·ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯åœ¨ ssh åçš„è¿œç¨‹ç›®å½•æ‰§è¡Œdocekr build</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh &quot;ssh $&#123;env.DEPLOY_REMOTE_SERVER&#125; \&quot;cd $&#123;env.DEPLOY_DIR_MAIN&#125; &amp;&amp; pwd &amp;&amp; docker build -t xxx-server .\&quot;&quot;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<ol start="5">
<li>æƒé™å‘ ï¼Œxxxç”¨æˆ·æ˜¯æ²¡æœ‰docker å‘½ä»¤è¿è¡Œæƒé™çš„ã€‚</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">permission denied while trying to connect to the Docker daemon socket at unix:&#x2F;&#x2F;&#x2F;var&#x2F;run&#x2F;docker.sock: Get &quot;http:&#x2F;&#x2F;%2Fvar%2Frun%2Fdocker.sock&#x2F;_ping&quot;: dial unix &#x2F;var&#x2F;run&#x2F;docker.sock: connect: permission denied</span><br></pre></td></tr></table></figure>

<p>   éœ€è¦åˆ‡æ¢åˆ°rootç”¨æˆ·æ‰§è¡Œï¼ŒæŠŠxxxç”¨æˆ·æ·»åŠ åˆ°dockerç”¨æˆ·ç»„</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo usermod -aG docker xxx</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>è¿è¡Œåœ¨docker ä¸­çš„javaç¨‹åºæƒ³è¦é“¾æ¥å¦ä¸€ä¸ªå®¹å™¨çš„redisï¼Œä¸èƒ½ä½¿ç”¨127.0.0.1 æˆ–è€…localhost</li>
</ol>
<ul>
<li><p>å¯ä»¥åœ¨è¿è¡Œæ—¶å€™ï¼Œredisï¼Œjavaåº”ç”¨éƒ½ä½¿ç”¨ -network ç»„åŒä¸€ä¸ªç½‘ï¼Œç„¶åä½¿ç”¨å®¹å™¨åç§°è¿æ¥å³å¯</p>
</li>
<li><p>æˆ–è€…ä½¿ç”¨å‘½ä»¤æŸ¥çœ‹ä¸‹redis çš„å®¹å™¨åœ°å€ã€‚ä½¿ç”¨å®¹å™¨ipåœ°å€æ¥è¿æ¥</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker inspect -f &#39;&#123;&#123;range .NetworkSettings.Networks&#125;&#125;&#123;&#123;.IPAddress&#125;&#125;&#123;&#123;end&#125;&#125;&#39; redis</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ol start="7">
<li><p>docker run è¿è¡Œçš„æ—¶å€™ä¸€å®šè¦è®°å¾—åŠ ä¸Š-d åå°è¿è¡Œï¼Œä¸ç„¶æ— æ³•æ‰§è¡Œåˆ°ä¸‹ä¸€æ­¥ã€‚</p>
</li>
<li><p>javaé¡¹ç›®Captchaç”ŸæˆéªŒè¯ç ï¼Œdockeréƒ¨ç½²æ—¶å­—ä½“åŒ…ç©ºæŒ‡é’ˆå¼‚å¸¸<br>åŸå› æ˜¯åˆ¶ä½œé•œåƒæ—¶ä½¿ç”¨çš„ openjdk:8-jdk-alpine æ²¡æœ‰ç›¸å…³å­—ä½“åŒ…ï¼Œè°ƒç”¨createImage()æ–¹æ³•æ—¶ï¼Œä¼šæŠ¥ç©ºæŒ‡é’ˆå¼‚å¸¸<br>è§£å†³æ–¹æ¡ˆå°±æ˜¯åœ¨dockerfileä¸­å¢åŠ ä»¥ä¸‹ä»£ç ï¼š</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FROM openjdk:8-jre-alpine</span><br><span class="line"></span><br><span class="line">#captcher å­—ä½“åŒ…</span><br><span class="line">RUN set -xe \</span><br><span class="line">&amp;&amp; apk --no-cache add ttf-dejavu fontconfig</span><br></pre></td></tr></table></figure>

<p>æœ€ç»ˆdockerfile ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"># æ„å»ºé•œåƒçš„ç¬¬äºŒé˜¶æ®µ</span><br><span class="line"></span><br><span class="line">FROM openjdk:8-jre-alpine</span><br><span class="line"></span><br><span class="line"># captcher å­—ä½“åŒ…</span><br><span class="line">RUN set -xe \</span><br><span class="line">&amp;&amp; apk --no-cache add ttf-dejavu fontconfig</span><br><span class="line"></span><br><span class="line"># è®¾ç½®å·¥ä½œç›®å½•</span><br><span class="line"></span><br><span class="line">WORKDIR &#x2F;app</span><br><span class="line"></span><br><span class="line"># å°† jar æ–‡ä»¶å¤åˆ¶åˆ°å®¹å™¨ä¸­</span><br><span class="line"></span><br><span class="line">COPY ruoyi-admin.jar &#x2F;app&#x2F;</span><br><span class="line"></span><br><span class="line"># æš´éœ²çš„ç«¯å£ï¼Œæ ¹æ®æ‚¨çš„å®é™…é¡¹ç›®ç«¯å£è¿›è¡Œè°ƒæ•´</span><br><span class="line"></span><br><span class="line">EXPOSE 20111</span><br><span class="line"></span><br><span class="line"># è®¾ç½®å®¹å™¨å¯åŠ¨æ—¶æ‰§è¡Œçš„å‘½ä»¤</span><br><span class="line"></span><br><span class="line"># ENTRYPOINT [&quot;java&quot;, &quot;-jar&quot;, &quot;ruoyi-admin.jar&quot;]</span><br><span class="line">ENTRYPOINT [&quot;java&quot;, &quot;-Xms256m&quot;, &quot;-Xmx1024m&quot;, &quot;-XX:MetaspaceSize&#x3D;128m&quot;, &quot;-XX:MaxMetaspaceSize&#x3D;512m&quot;, &quot;-jar&quot;, &quot;ruoyi-admin.jar&quot;]</span><br><span class="line"></span><br><span class="line"># æ·»åŠ ä¸‹é¢è¿™ä¸€è¡Œï¼Œå°†å®¿ä¸»æœºçš„æ—¥å¿—ç›®å½•æŒ‚è½½åˆ°å®¹å™¨ä¸­</span><br><span class="line"></span><br><span class="line">VOLUME &#x2F;home&#x2F;xxxx&#x2F;logs:&#x2F;app&#x2F;logs</span><br></pre></td></tr></table></figure>

<p>jekinsfile:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line"></span><br><span class="line">    environment &#123;</span><br><span class="line">        &#x2F;&#x2F; ç›®å½•éš¶å±ç”¨æˆ·ç”¨æˆ·ç»„</span><br><span class="line">        DEPLOY_DIR_USER &#x3D; &#39;xxx&#39;</span><br><span class="line">        &#x2F;&#x2F; é¡¹ç›®</span><br><span class="line">        PROJECT_MAIN &#x3D; &#39;main_project&#39;</span><br><span class="line">        &#x2F;&#x2F; æ‰“åŒ…å¥½çš„ä¸»ç›®å½•</span><br><span class="line">        TARGET_HOME_DIR &#x3D; &quot;$&#123;env.WORKSPACE&#125;&quot;</span><br><span class="line">        &#x2F;&#x2F; è¿œç¨‹ä¸»æœºip</span><br><span class="line">        DEPLOY_REMOTE_SERVER &#x3D; &#39;xxx@10.0.0.è¿œç¨‹&#39;</span><br><span class="line">        &#x2F;&#x2F; è¿œç¨‹éƒ¨ç½²ç›®å½•</span><br><span class="line">        DEPLOY_DIR_MAIN &#x3D; &quot;$&#123;params.DEPLOY_DIR_MAIN&#125;&quot;</span><br><span class="line">        &#x2F;&#x2F; jaråŒ…è·¯å¾„</span><br><span class="line">        JAR_DIR &#x3D; &#39;ruoyi-admin&#x2F;target&#x2F;ruoyi-admin.jar&#39;</span><br><span class="line"></span><br><span class="line">        JAR_NAME &#x3D; &#39;ruoyi-admin.jar&#39;</span><br><span class="line"></span><br><span class="line">        CONTAINER_NAME &#x3D; &#39;xxx-server&#39;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(&#39;Clean&#39;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                &#x2F;&#x2F; clean workspace</span><br><span class="line">                cleanWs()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage(&#39;Checkout&#39;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                dir(&quot;$&#123;env.PROJECT_MAIN&#125;&quot;) &#123;</span><br><span class="line">                    checkout scm</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage(&#39;Create Directories&#39;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh &quot;mkdir -p $&#123;env.TARGET_HOME_DIR&#125;&#x2F;$&#123;env.PROJECT_MAIN&#125;&#x2F;public&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&#39;Generate log HTML &#39;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                echo &quot;$&#123;params.environmental_main&#125;&quot;</span><br><span class="line">                dir(&quot;$&#123;env.PROJECT_MAIN&#125;&quot;) &#123;</span><br><span class="line">                    sh &quot;git log -20 --grep&#x3D;\&quot;^Merge pull request\&quot; --pretty&#x3D;format:\&quot;%H&lt;br&gt;\&quot; -20 | awk &#39;&#123;printf \&quot;%s\&quot;, \$0&#125;&#39; &gt; $&#123;env.TARGET_HOME_DIR&#125;&#x2F;$&#123;env.PROJECT_MAIN&#125;&#x2F;public&#x2F;result.html&quot;</span><br><span class="line">                &#125;</span><br><span class="line">                echo &quot;version:$&#123;env.BUILD_NUMBER&#125;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&#39;mvn clean package&#39;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                dir(&quot;$&#123;env.PROJECT_MAIN&#125;&quot;) &#123;</span><br><span class="line">                    sh &#39;mvn clean package -Dmaven.test.skip&#x3D;true&#39;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&#39;Deploy&#39;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">             &#x2F;&#x2F; è„šæœ¬ç”Ÿæˆ</span><br><span class="line">            &#x2F;&#x2F; sshPublisher(publishers: [sshPublisherDesc(configName: &#39;nginx_server&#39;, transfers: [sshTransfer(cleanRemote: false, excludes: &#39;&#39;, execCommand: &#39;&#39;, execTimeout: 120000, flatten: false, makeEmptyDirs: false, noDefaultExcludes: false, patternSeparator: &#39;[, ]+&#39;, remoteDirectory: &#39;&#x2F;&#39;, remoteDirectorySDF: false, removePrefix: &#39;build&#39;, sourceFiles: &#39;build&#x2F;**&#39;)], usePromotionTimestamp: false, useWorkspaceInPromotion: false, verbose: false)])</span><br><span class="line"></span><br><span class="line">                echo &quot;æ¸…ç©ºéƒ¨ç½²ç›®å½•ä¸‹çš„jaræ–‡ä»¶ [$&#123;env.DEPLOY_DIR_MAIN&#125;&#x2F;$&#123;env.JAR_NAME&#125;] ... start&quot;</span><br><span class="line"></span><br><span class="line">                sh &quot;ssh $&#123;env.DEPLOY_REMOTE_SERVER&#125; rm  $&#123;env.DEPLOY_DIR_MAIN&#125;&#x2F;$&#123;env.JAR_NAME&#125;&quot;</span><br><span class="line"></span><br><span class="line">                echo &quot;æ¸…ç©ºéƒ¨ç½²ç›®å½•ä¸‹çš„jaræ–‡ä»¶ [$&#123;env.DEPLOY_DIR_MAIN&#125;&#x2F;$&#123;env.JAR_NAME&#125;]  ... ok&quot;</span><br><span class="line"></span><br><span class="line">                echo &quot;æ¸…ç©ºéƒ¨ç½²ç›®å½•ä¸‹çš„DockerFileæ–‡ä»¶ [$&#123;env.DEPLOY_DIR_MAIN&#125;&#x2F;Dockerfile] ... start&quot;</span><br><span class="line"></span><br><span class="line">                sh &quot;ssh $&#123;env.DEPLOY_REMOTE_SERVER&#125; rm  $&#123;env.DEPLOY_DIR_MAIN&#125;&#x2F;Dockerfile&quot;</span><br><span class="line"></span><br><span class="line">                echo &quot;æ¸…ç©ºéƒ¨ç½²ç›®å½•ä¸‹çš„jaræ–‡ä»¶ [$&#123;env.DEPLOY_DIR_MAIN&#125;&#x2F;Dockerfile]  ... ok&quot;</span><br><span class="line"></span><br><span class="line">                echo &quot;å¤åˆ¶éƒ¨ç½²jaræ–‡ä»¶ [$&#123;env.TARGET_HOME_DIR&#125;&#x2F;$&#123;env.PROJECT_MAIN&#125;&#x2F;$&#123;env.JAR_DIR&#125;] to [$&#123;env.DEPLOY_DIR_MAIN&#125;] ... start&quot;</span><br><span class="line"></span><br><span class="line">                sh &quot;scp -r $&#123;env.TARGET_HOME_DIR&#125;&#x2F;$&#123;env.PROJECT_MAIN&#125;&#x2F;$&#123;env.JAR_DIR&#125; $&#123;env.DEPLOY_REMOTE_SERVER&#125;:$&#123;env.DEPLOY_DIR_MAIN&#125;&quot;</span><br><span class="line"></span><br><span class="line">                echo &quot;å¤åˆ¶éƒ¨ç½²jaræ–‡ä»¶ [$&#123;env.TARGET_HOME_DIR&#125;&#x2F;$&#123;env.PROJECT_MAIN&#125;&#x2F;$&#123;env.JAR_DIR&#125;] to [$&#123;env.DEPLOY_DIR_MAIN&#125;] ... ok&quot;</span><br><span class="line"></span><br><span class="line">                echo &quot;å¤åˆ¶Dockerfileæ–‡ä»¶ [$&#123;env.TARGET_HOME_DIR&#125;&#x2F;$&#123;env.PROJECT_MAIN&#125;&#x2F;Dockerfile] to [$&#123;env.DEPLOY_DIR_MAIN&#125;] ... start&quot;</span><br><span class="line"></span><br><span class="line">                sh &quot;scp -r $&#123;env.TARGET_HOME_DIR&#125;&#x2F;$&#123;env.PROJECT_MAIN&#125;&#x2F;Dockerfile $&#123;env.DEPLOY_REMOTE_SERVER&#125;:$&#123;env.DEPLOY_DIR_MAIN&#125;&quot;</span><br><span class="line"></span><br><span class="line">                echo &quot;å¤åˆ¶Dockerfileæ–‡ä»¶ [$&#123;env.TARGET_HOME_DIR&#125;&#x2F;$&#123;env.PROJECT_MAIN&#125;&#x2F;Dockerfile] to [$&#123;env.DEPLOY_DIR_MAIN&#125;] ... ok&quot;</span><br><span class="line"></span><br><span class="line">                echo &#39;docker æ‰“åŒ…  ...start&#39;</span><br><span class="line"></span><br><span class="line">                &#x2F;&#x2F; sh &quot;ssh $&#123;env.DEPLOY_REMOTE_SERVER&#125; cd $&#123;env.DEPLOY_DIR_MAIN&#125; &amp;&amp; pwd &amp;&amp; docker build -t xxx-server .&quot;</span><br><span class="line"></span><br><span class="line">                sh &quot;ssh $&#123;env.DEPLOY_REMOTE_SERVER&#125; \&quot;cd $&#123;env.DEPLOY_DIR_MAIN&#125; &amp;&amp; pwd &amp;&amp; docker build -t xxx-server .\&quot;&quot;</span><br><span class="line"></span><br><span class="line">                echo &#39;docker æ‰“åŒ…  ...ok&#39;</span><br><span class="line"></span><br><span class="line">                script &#123;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        echo &quot;åˆ¤æ–­ä¸‹æœ‰æ²¡æœ‰$&#123;env.CONTAINER_NAME&#125;å®¹å™¨&quot;</span><br><span class="line">                        def containerExists &#x3D; sh(</span><br><span class="line">                        returnStatus: true,</span><br><span class="line">                        script: &quot;docker ps -aqf name&#x3D;$&#123;env.CONTAINER_NAME&#125;&quot;</span><br><span class="line">                    ) &#x3D;&#x3D; 0</span><br><span class="line">                        if (containerExists) &#123;</span><br><span class="line">                            echo &quot;$&#123;env.CONTAINER_NAME&#125;å®¹å™¨ å­˜åœ¨&quot;</span><br><span class="line"></span><br><span class="line">                            sh &quot;docker stop $&#123;env.CONTAINER_NAME&#125;&quot;</span><br><span class="line"></span><br><span class="line">                            echo &quot;$&#123;env.CONTAINER_NAME&#125;å®¹å™¨ åœæ­¢&quot;</span><br><span class="line"></span><br><span class="line">                            sh &quot;docker rm $&#123;env.CONTAINER_NAME&#125;&quot;</span><br><span class="line"></span><br><span class="line">                            echo &quot;$&#123;env.CONTAINER_NAME&#125;å®¹å™¨ åˆ é™¤&quot;</span><br><span class="line">                        &#125;</span><br><span class="line">                        echo &#39;docker åå°å¯åŠ¨  ...start&#39;</span><br><span class="line"></span><br><span class="line">                        sh &quot;ssh $&#123;env.DEPLOY_REMOTE_SERVER&#125; docker run -d --name xxx-server -p 20111:20111 -v &#x2F;home&#x2F;xxx&#x2F;xxx-server&#x2F;logs:&#x2F;app&#x2F;logs -v xxx-server-data:&#x2F;data xxx-server&quot;</span><br><span class="line"></span><br><span class="line">                        echo &#39;docker å¯åŠ¨  ...ok&#39;</span><br><span class="line">                        &#x2F;&#x2F;è°ƒç”¨æ–¹æ³•å¾—åˆ°æ—¥å¿— å¹¶ è¾“å‡º</span><br><span class="line"></span><br><span class="line">                        def changeString &#x3D; getChangeString()</span><br><span class="line">                        echo &quot;$changeString&quot;</span><br><span class="line">                        &#x2F;&#x2F; å‘é€æ¶ˆæ¯</span><br><span class="line">                        slackSend channel: &#39;#xxx-verify&#39;, color: &#39;#7CFC00&#39;, message: &quot;xxx-server-æ‰“åŒ…éƒ¨ç½²æˆåŠŸ swaggeræ–‡æ¡£åœ°å€ï¼š$&#123;params.deploySite1&#125; \n Build Started: $&#123;env.JOB_NAME&#125; $&#123;env.BUILD_NUMBER&#125; \n æäº¤ä¿¡æ¯: \n $changeString&quot;, teamDomain: &#39;xxxx&#39;, tokenCredentialId: &#39;xxx&#39;</span><br><span class="line"></span><br><span class="line">                        echo &#39;\n--------------- éƒ¨ç½²å®Œæˆ ---------------&#39;</span><br><span class="line">                &#125; catch (err) &#123;</span><br><span class="line">                        echo &quot;éƒ¨ç½²å¤±è´¥: $&#123;err&#125;&quot;</span><br><span class="line">                        currentBuild.result &#x3D; &#39;FAILURE&#39;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@NonCPS</span><br><span class="line">def getChangeString() &#123;</span><br><span class="line">    MAX_MSG_LEN &#x3D; 100</span><br><span class="line">    def changeString &#x3D; &#39;&#39;</span><br><span class="line"></span><br><span class="line">    echo &#39;Gathering SCM changes&#39;</span><br><span class="line">    def changeLogSets &#x3D; currentBuild.changeSets</span><br><span class="line">    for (int i &#x3D; 0; i &lt; changeLogSets.size(); i++) &#123;</span><br><span class="line">        def entries &#x3D; changeLogSets[i].items</span><br><span class="line">        for (int j &#x3D; 0; j &lt; entries.length; j++) &#123;</span><br><span class="line">            def entry &#x3D; entries[j]</span><br><span class="line">            truncated_msg &#x3D; entry.msg.take(MAX_MSG_LEN)</span><br><span class="line">            changeString +&#x3D; &quot; - $&#123;truncated_msg&#125; [$&#123;entry.author&#125;]\n&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (!changeString) &#123;</span><br><span class="line">        changeString &#x3D; &#39; - No new changes&#39;</span><br><span class="line">    &#125;</span><br><span class="line">    return changeString</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="mailto:undefined">å°é»‘</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="http://ynxh.xyz/2023/05/09/%E8%BF%90%E7%BB%B4/jenkins%E9%83%A8%E7%BD%B2java%E5%BA%94%E7%94%A8/">http://ynxh.xyz/2023/05/09/è¿ç»´/jenkinséƒ¨ç½²javaåº”ç”¨/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="http://ynxh.xyz" target="_blank">å°é»‘çš„å°ç«™</a>ï¼</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/img/javascript.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> æ‰“èµ<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/wechat.jpg" alt="å¾®ä¿¡"/><div class="post-qr-code__desc">å¾®ä¿¡</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/alipay.jpg" alt="æ”¯ä»˜å¯¶"/><div class="post-qr-code__desc">æ”¯ä»˜å¯¶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2023/05/09/%E8%BF%90%E7%BB%B4/%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3/"><img class="prev_cover lazyload" data-src="/img/linux.jpeg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">è¿ç»´/ç½‘ç»œç›¸å…³</div></div></a></div><div class="next-post pull_right"><a href="/2023/04/25/%E8%BF%90%E7%BB%B4/jenkins%E4%BD%BF%E7%94%A8/"><img class="next_cover lazyload" data-src="/img/linux.jpeg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">è¿ç»´/jenkinsä½¿ç”¨</div></div></a></div></nav></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By å°é»‘</div><div class="footer_custom_text">Hi, welcome to my <a href="http://ynxh.xyz/">blog</a>!</div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="é˜…è¯»æ¨¡å¼"></i><i class="fa fa-plus" id="font_plus" title="æ”¾å¤§å­—ä½“"></i><i class="fa fa-minus" id="font_minus" title="ç¼©å°å­—ä½“"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="ç®€ç¹è½¬æ¢" target="_self">2</a><i class="darkmode fa fa-moon-o" id="darkmode" title="å¤œé—´æ¨¡å¼"></i></div><div id="rightside-config-show"><div id="rightside_config" title="è®¾ç½®"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="ç›®å½•" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="å›åˆ°é¡¶éƒ¨" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script id="canvas_nest" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="/js/third-party/canvas-nest.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script><script src="/js/third-party/click_heart.js"></script></body></html>